#!/bin/bash
# Rongle CLI ‚Äî Unified management tool

set -e

function show_help {
    echo "ü¶Ü Rongle Management CLI"
    echo "--------------------------------------------------------"
    echo "Usage: ./scripts/rongle [COMMAND]"
    echo ""
    echo "  üöÄ Development"
    echo "     start       Start the full stack via Docker Compose"
    echo "     stop        Stop all running services"
    echo "     restart     Restart all services"
    echo "     logs        Follow logs from all containers"
    echo ""
    echo "  üß™ Testing & Quality"
    echo "     test        Run all unit tests (Frontend + Backend)"
    echo "     verify      Check local environment prerequisites"
    echo "     pixel       Run the interactive Pixel 10 Setup Wizard"
    echo ""
    echo "  üõ†Ô∏è  Ops"
    echo "     build       Rebuild Docker images"
    echo "     shell       Open a bash shell inside the operator container"
    echo "--------------------------------------------------------"
    echo "See docs/ONBOARDING.md for more details."
    echo ""
}

case "$1" in
    start)
        echo "Starting Rongle Stack..."
        docker-compose up -d
        ;;
    stop)
        echo "Stopping Rongle Stack..."
        docker-compose down
        ;;
    restart)
        docker-compose restart
        ;;
    logs)
        docker-compose logs -f
        ;;
    test)
        echo "=== Frontend Tests ==="
        npm run test
        echo "=== Backend Tests ==="
        # If running in docker, use docker exec. Else local pytest.
        if [ -f /.dockerenv ]; then
            pytest rng_operator/tests
        else
            npm run test:backend
        fi
        ;;
    build)
        docker-compose build
        ;;
    pixel)
        python3 scripts/setup_pixel_test.py
        ;;
    shell)
        docker-compose exec operator /bin/bash
        ;;
    verify)
        echo "Checking environment..."
        python3 -c "import cv2; print(f'OpenCV: {cv2.__version__}')"
        node -v
        npm -v
        echo "OK"
        ;;
    *)
        show_help
        ;;
esac
